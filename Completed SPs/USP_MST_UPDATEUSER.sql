USE [UETCLWIS]
GO
/****** Object:  StoredProcedure [dbo].[USP_MST_UPDATEUSER]    Script Date: 10/23/2017 5:52:05 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[USP_MST_UPDATEUSER]  
   /*
   *   SSMA warning messages:
   *   O2SS0356: Conversion from NUMBER datatype can cause data loss.
   */

   @userid_ float(53),
   @username_ varchar(max),
   @pwd_ varchar(max),
   @emailid_ varchar(max),
   @displayname_ varchar(max),
   /*
   *   SSMA warning messages:
   *   O2SS0356: Conversion from NUMBER datatype can cause data loss.
   */

   @roleid_ float(53),
   @cellnumber_ varchar(max),
   @isdeleted_ varchar(max),
   /*
   *   SSMA warning messages:
   *   O2SS0356: Conversion from NUMBER datatype can cause data loss.
   */

   @updatedby_ float(53),
   @updateddate_ datetime2(0),
   @errorMessage_ varchar(max)  OUTPUT
AS 
   /*Generated by SQL Server Migration Assistant for Oracle version 6.0.0.*/
   BEGIN

      SET @errorMessage_ = NULL

      DECLARE
         /*
         *   SSMA warning messages:
         *   O2SS0356: Conversion from NUMBER datatype can cause data loss.
         */

         @row_count float(53), 
         /*
         *   SSMA warning messages:
         *   O2SS0356: Conversion from NUMBER datatype can cause data loss.
         */

         @rowcount_MailID float(53), 
         /*
         *   SSMA warning messages:
         *   O2SS0356: Conversion from NUMBER datatype can cause data loss.
         */

         @rowcount_CellNumber float(53)

      
      /*
      *   ProjectRoute_Id Number;
      *   ********************************************************************************************************                  
      *   Procedure Name    : USP_MST_UPDATEUSER
      *   Author            : Wilson abigaba           
      *   Created Date      : 24/10/2017                
      *   Copyright©        : Copyright © UETCL
      *   __________________________________________________________________________________________________________
      *   Purpose: For Updating mst_user Master Records based on RoleId
      *   __________________________________________________________________________________________________________
      *   Input Parameters  1.userid_
      *                     2.username_
      *                     3.pwd_
      *                     4.emailid_
      *                     5.displayname_
      *                     6.roleid_
      *                     7.cellnumber_
      *                     8.isdeleted_
      *                     9.createdby_
      *                     10.createddate_
      *   __________________________________________________________________________________________________________
      *   Tables Used : 1. mst_user
      *   __________________________________________________________________________________________________________
      *   Modules Affected : 1. MASTER
      *   __________________________________________________________________________________________________________
      *   *********************************************************************************************************
      */
      SELECT @row_count = count_big(1)
      FROM dbo.MST_USER
      WHERE lower(MST_USER.USERNAME) = lower(@username_) AND MST_USER.USERID <> @userid_

      IF @row_count = 0
         BEGIN

            SELECT @rowcount_MailID = count_big(1)
            FROM dbo.MST_USER
            WHERE lower(MST_USER.EMAILID) = lower(@emailid_) AND MST_USER.USERID <> @userid_

            IF @rowcount_MailID = 0
               BEGIN

                  SELECT @rowcount_CellNumber = count_big(1)
                  FROM dbo.MST_USER
                  WHERE lower(MST_USER.CELLNUMBER) = lower(@cellnumber_) AND MST_USER.USERID <> @userid_

                  IF @rowcount_CellNumber = 0
                     BEGIN

                        UPDATE dbo.MST_USER
                           SET 
                              USERNAME = @username_, 
                              PWD = @pwd_, 
                              EMAILID = @emailid_, 
                              DISPLAYNAME = @displayname_, 
                              ROLEID = @roleid_, 
                              CELLNUMBER = @cellnumber_, 
                              UPDATEDBY = @updatedby_, 
                              UPDATEDDATE = @updateddate_
                        WHERE MST_USER.USERID = @userid_

                        SET @errormessage_ = NULL

                        /*---------New ----*/
                        UPDATE dbo.TRN_PROJECT_PERSONNEL
                           SET 
                              ROLEID = @roleid_
                        WHERE TRN_PROJECT_PERSONNEL.USERID = @userid_

                        UPDATE dbo.TRN_WORKFLOW_APPROVER
                           SET 
                              ROLEID = @roleid_
                        WHERE TRN_WORKFLOW_APPROVER.USERID = @userid_

                        /*---------End -----*/
                        IF @@TRANCOUNT > 0
                           COMMIT WORK 

                     END
                  ELSE 
                     SET @errormessage_ = 'Cell number ' + ISNULL(@cellnumber_, '') + ' already exists in the system.'

               END
            ELSE 
               SET @errormessage_ = 'Emailid ' + ISNULL(@emailid_, '') + ' already exists in the system.'

         END
      ELSE 
         SET @errormessage_ = 'User ' + ISNULL(@username_, '') + ' already exists in the system.'

   END